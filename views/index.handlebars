<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
		crossorigin="anonymous"></script>
	<style>
		.button {
			border: none;
			color: white;
			padding: 15px 32px;
			text-align: center;
			text-decoration: none;
			display: inline-block;
			font-size: 80px;
			margin: 4px 2px;
			cursor: pointer;
			background-color: #008CBA;
			border: 2px #ccc solid;
			border-radius: 30px;
		}

		.result {
			display: flex;
			justify-content: center;
			align-items: center;
			color: #008CBA;
			font-size: 50px;
		}

		.result #show_result {
			color: #008CBA;
			font-size: 50px;
		}

		.part1 {
			display: flex;
			justify-content: center;
			align-items: center;
		}

		.lottery {
			width: 85%;
			height: 500px;
			margin: 20px;
		}
	</style>
</head>

<body>
	<div id="area" class="part1 container">
		<div class="lottery row">
			<input  class="button" type="button" value="點我抽獎" onclick="getLottery()">
		</div>
	</div>

	<div id="result" class="result container" hidden="true">
		<div class="row">
			<div id="show_result"></div>
		</div>

	</div>


</body>

<!-- script -->
<script type="text/javascript">
	var prizeList = [{ "id": 1, "prize": "銘謝惠顧", "count": 2 }, { "id": 2, "prize": "薯條100元", "count": 2 }, { "id": 3, "prize": "紅包500元", "count": 2 }]
	var lotterylist = [];

	function getLottery() {
		document.getElementById("show_result").innerText = "";

		var luckyNum = getRandomInt(lotterylist.length);
		//console.log(lotterylist[luckyNum]);
		document.getElementById("result").hidden = false;
		document.getElementById("area").hidden = true;
		document.getElementById("show_result").append("抽中: " + lotterylist[luckyNum].prize);

		//將抽到的獎項，扣掉數量
		updateList(luckyNum);

		//回寫file
		var url = 'https://testlottery123.herokuapp.com/write';
		var data = prizeList;

		fetch(url, {
			method: 'POST', // or 'PUT'
			body: JSON.stringify(data), // data can be `string` or {object}!
			headers: new Headers({
				'Content-Type': 'application/json'
			})
		}).then(res => res.json())
			.catch(error => console.error('Error:', error))
			.then(response => console.log('Success:', response));
	}

	function resetPrizeList(InsPrize) {
		prizeList = []; //清空抽獎列
		lotterylist = []; //清空抽獎列
		var count = 0;
		for (var idx = 0; idx < InsPrize.length; idx++) {
			prizeList.push({
				"id": idx,
				"prize": InsPrize[idx].substring(0, InsPrize[idx].indexOf("|")),
				"count": InsPrize[idx].substring(InsPrize[idx].indexOf("|") + 1, InsPrize[idx].length)
			});
			for (var j = 0; j < InsPrize[idx].substring(InsPrize[idx].indexOf("|") + 1, InsPrize[idx].length); j++) {
				lotterylist.push({
					"id": count,
					"prize": InsPrize[idx].substring(0, InsPrize[idx].indexOf("|"))
				});
				count++;
			}
		}
		//console.log(prizeList)
		//console.log(lotterylist)
	}

	function getRandomInt(max) {
		return Math.floor(Math.random() * max);
	}

	function updateList(luckyNum) {
		var cnt = 0;
		for(var i = 0; i < prizeList.length; i++) {
			if (prizeList[i].prize == lotterylist[luckyNum].prize) {
				prizeList[i].count--;
				lotterylist.splice(luckyNum, 1);
				if (prizeList[i].count == 0) 
					prizeList.splice(i, 1);
			} else {
				prizeList[i].id = cnt;
				cnt++;
			}
		}
		console.log("prizeList", prizeList);
		console.log("lotterylist", lotterylist);
	}

	window.onload = function () {
		var request = new Request('https://testlottery123.herokuapp.com/');
		var repspnse = fetch(request, {
			method: 'GET',
			headers: {
				'Content-Type': 'application/json'
			},
			mode: 'no-cors'
		})
			.then(response => {
				response.json().then(json => {
					//console.log(text);  // 成功拿到 response.body 的 json 資料
					resetPrizeList(json.arr)
				})
			})
			.catch(function (error) {
				console.log('Request failed', error)
			});


	}
</script>

</html>